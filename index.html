<textarea id="content" rows="10" style="width:100%;"></textarea>
<div style="margin:10px 0;">
  <button onclick="formatText('strong')"><b>B</b></button>
  <button onclick="formatText('em')"><i>I</i></button>
  <button onclick="formatText('h2')">H2</button>
  <button onclick="formatList()">UL</button>
  <button onclick="addImage()">Image</button>
  <button onclick="publish()">Publish</button>
</div>

<script>
// Wrap selected text in a tag
function formatText(tag) {
  const textarea = document.getElementById('content');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selected = textarea.value.slice(start, end);
  textarea.value = textarea.value.slice(0, start) +
                   `<${tag}>${selected}</${tag}>` +
                   textarea.value.slice(end);
}

// Wrap selected text in <ul><li>
function formatList() {
  const textarea = document.getElementById('content');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selected = textarea.value.slice(start, end)
                     .split('\n')
                     .map(l => `<li>${l}</li>`).join('');
  textarea.value = textarea.value.slice(0, start) +
                   `<ul>${selected}</ul>` +
                   textarea.value.slice(end);
}

// Insert GitHub image
function addImage() {
  const url = prompt("Enter raw GitHub image URL:");
  if (!url) return;
  const textarea = document.getElementById("content");
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  textarea.value = textarea.value.slice(0, start) +
                   `<img src="${url}" alt="" style="max-width:100%;">` +
                   textarea.value.slice(end);
}

// Publish post
async function publish() {
  const text = document.getElementById("content").value;
  if (!text.trim()) return alert("Write something!");

  try {
    const res = await fetch("/publish", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ content: text })
    });

    if (!res.ok) {
      const err = await res.json();
      return alert("Publish failed: " + (err.error || res.status));
    }

    const data = await res.json();
    window.location.href = window.location.origin + data.url;
  } catch (e) {
    alert("Publish error: " + e.message);
  }
}
</script>
